name: CD - Backend

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - ".github/workflows/cd-backend.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: ap-northeast-2
      # Terraform output의 repo url을 registry로 쓰는게 아니라,
      # ecr-login step에서 registry를 받아서 씁니다.
      ECR_REPO: uppick-api
      SSM_ENV_PATH: /uppick/prod/env
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push (backend)
        working-directory: backend
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"
          docker build -t "${IMAGE_URI}" .
          docker push "${IMAGE_URI}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      - name: Update SSM APP_IMAGE
        run: |
          set -euo pipefail
          aws ssm put-parameter \
            --name "${SSM_ENV_PATH}/APP_IMAGE" \
            --type "String" \
            --value "${IMAGE_URI}" \
            --overwrite

      - name: Deploy on EC2 via SSM (docker-compose)
        run: |
          set -euo pipefail
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "${EC2_INSTANCE_ID}" \
            --comment "Deploy backend ${GITHUB_SHA}" \
            --parameters commands='[
              "set -euo pipefail",
              "cd /opt/uppick",
              "aws ssm get-parameters-by-path --path \"'"${SSM_ENV_PATH}"'\" --recursive --with-decryption --output json > /tmp/ssm_env.json",
              "jq -r \".Parameters[] | \\\"\\(.Name | split(\\\"/\\\")[-1])=\\(.Value // \\\"\\\")\\\"\" /tmp/ssm_env.json > .env",
              "aws ecr get-login-password --region ap-northeast-2 | sudo docker login --username AWS --password-stdin 109936653790.dkr.ecr.ap-northeast-2.amazonaws.com",
              "sudo docker-compose --profile app pull uppick-app-001 uppick-app-002",
              "sudo docker-compose --profile app up -d --no-deps --force-recreate uppick-app-001 uppick-app-002",
              "sudo docker image prune -af || true"
            ]'